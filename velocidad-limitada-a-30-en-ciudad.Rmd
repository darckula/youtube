---
title: "Nuevos límites de velocidad en España"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=F, warning=F, echo=FALSE)
library(tidyverse)
library(extrafont)
theme_default <- theme_set(theme_light())
theme_update(
    text         = element_text(family = "Ubuntu")
  , plot.title   = element_text(size = 20)
  , axis.text    = element_text(size = 12)
  , legend.text  = element_text(size = 12))

```

* Entra en vigor: 11 Mayo 2021
* 30 km/h para las calles con un único carril de circulación para cada sentido.
* 20 km/h si entre los vehiculos y los peatones no hay diferencia de altura.

# Razones:

* Reducir la siniestralidad vial
* Reducir la calidad del aire
* Distancia de frenado:
  * 30 km/h se necesitan 15 metros - 10% lesion grave o mortal
  * 50 km/h se necesitan 30 metros - 50% lesion grave o mortal
* Teoria

# Fallecidos

* En España 418.703 personas murieron en 2019
* 228 personas murieron atropelladas en ciudad
* -0.05% de reducción de la mortalidad

# Consecuencias

* Mucha confusión
* Estrés para el conductor
* Mas atascos
* Mas tiempo parados en los semáforos:
  * más contaminacion
  * más ruido
* Afan recaudatorio
  


```{r}
acc_trafico <- tribble(
  ~zona, ~victimas, ~fallecidos,
  "vias interurbanas", 900, 134,
  "travesias", 254, 19,
  "calles", 13248, 228
)

acc_trafico <- 
  acc_trafico %>%
  mutate(
    ratio        = 100*fallecidos/victimas,
    no_fallecidos = victimas - fallecidos)

acc_trafico <- 
  acc_trafico %>% 
    pivot_longer(
      cols = c(fallecidos, no_fallecidos),
      names_to = "tipo",
      values_to = "num_personas")

acc_trafico %>% 
  ggplot(aes(x=zona, y=num_personas, fill=tipo)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_fill_brewer(palette = 3, type = "qual", direction = -1) +
  geom_text(aes(label = num_personas)
            , position = position_dodge(width = 1)
            , colour = "black"
            , family = "Ubuntu"
            , vjust = 0
            , hjust = "center"
            , size = 5) +
  xlab(NULL) +
  ylab(NULL) +
  labs(
    title = "Peatones víctimas de accidentes de tráfico",
    subtitle = "Datos de la DGT 2019",
    caption = "Twitter: @darckula") +
  scale_y_log10() +
  theme(legend.position = "bottom", legend.title = element_blank())

acc_trafico %>% 
  ggplot(aes(x=zona, y=num_personas, fill=tipo)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_fill_brewer(palette = 3, type = "qual", direction = -1) +
  geom_text(aes(y = 0.75, label = paste(round(ratio,2), "%"))
            , colour = "blue4"
            , family = "Ubuntu"
            , size = 8) +
  xlab(NULL) +
  ylab(NULL) +
  labs(
    title = "Proporción de la mortalidad en atropellos a peatones",
    subtitle = "Datos de la DGT 2019",
    caption = "Twitter: @darckula") +
  scale_y_continuous(labels = c("0%", "25%", "50%", "75%", "100%")) +
  theme(legend.position = "bottom", legend.title = element_blank())


fallecimientos_peaton <- tribble(
  ~año, ~zona, ~infraccion, ~no_infraccion, ~desconocido,
  2019, "vias interurbanas", 92, 18, 24,
  2019, "travesia", 8, 4, 7,
  2019, "vias urbanas", 75, 92, 61
)

fallecimientos_peaton <- 
  fallecimientos_peaton %>% 
    pivot_longer(
        cols = c(infraccion, no_infraccion, desconocido)
      , names_to = "tipo"
      , values_to = "fallecidos")

fallecimientos_peaton %>% 
  ggplot(aes(zona, fallecidos, fill=tipo)) +
  geom_col(position = "dodge") +
  scale_fill_brewer(palette = 3, type = "seq", direction = 1) +
  geom_text(aes(label = fallecidos)
            , position = position_dodge(width = 1)
            , vjust = "bottom"
            , colour = "black"
            , family = "Ubuntu"
            , size = 5) +
  xlab(NULL) +
  ylab(NULL) +
  labs(
    title = "Infracciones en atropellos mortales a peatones",
    subtitle = "Datos de la DGT 2019",
    caption = "Twitter: @darckula") +
  theme(legend.position = "bottom", legend.title = element_blank())

text_to_show <- 
  fallecimientos_peaton %>%
    filter(tipo != "desconocido") %>%
    group_by(tipo) %>%
    summarize(fallecidos = sum(fallecidos)) %>% 
    mutate(pct = round(100 * fallecidos/sum(fallecidos)))

fallecimientos_peaton %>%
  filter(tipo != "desconocido") %>% 
  ggplot() +
  geom_col(aes(tipo, fallecidos, fill = zona), position = "stack") +
  scale_fill_brewer(palette = 3, type = "seq", direction = 1) +
  xlab(NULL) +
  ylab(NULL) +
  labs(
    title = "Atropellos mortales a peatones",
    subtitle = "Datos de la DGT 2019",
    caption = "Twitter: @darckula") +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  geom_text(  data = text_to_show 
            , aes(x = tipo, y = fallecidos, label = paste0(fallecidos, " (", pct, "%)"))
            , position = position_dodge(width = 1)
            , vjust = "bottom"
            , colour = "black"
            , family = "Ubuntu"
            , size = 5)
```

# Victimas por Ciudad

* Solo hay 4 provincias con más 20 fallecidos 
* Teruel, Salamanca y Melilla no presentan ningún fallecido

```{r}
fallecidos_ciudad <- read_csv(file = "fallecidos_ciudad.csv")

fallecidos_ciudad %>%
  filter(Provincia != "Total") %>% 
  ggplot(aes(reorder(Provincia, Fallecidos_Ciudad), Fallecidos_Ciudad)) +
  geom_col(fill = "#FF00FF") +
  coord_flip() +
  xlab(NULL) + ylab(NULL) +
  labs(
    title = "Accidentes mortales por provincia (incluye peatones y conductores)",
    subtitle = "Datos de la DGT 2019",
    caption = "Twitter: @darckula")
```
