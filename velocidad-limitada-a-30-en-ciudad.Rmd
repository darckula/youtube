---
title: "Nuevos límites de velocidad en España"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=F, warning=F)
library(tidyverse)
library(extrafont)
theme_default <- theme_set(theme_light())
theme_update(
    text         = element_text(family = "Ubuntu")
  , plot.title   = element_text(size = 20)
  , axis.text    = element_text(size = 12)
  , legend.text  = element_text(size = 12)
  , legend.position = "bottom", legend.title = element_blank()
  , strip.background = element_rect(fill = "#FF00FF")
  , strip.text = element_text(size = 12, color = "black", face = "bold"))

```

# Intro

* 11 Mayo 2021
* 50 km/h para calles de dos o más carriles para sentido de la circulación
* 30 km/h para las calles con un único carril de circulación para cada sentido
* 20 km/h si entre los vehiculos y los peatones no hay diferencia de altura

Segun la dgt, aprox. un 80% de la calles de España reducirán su velocidad de 50 Km/h a 30 km/h

# Razones

* Reducir la mortalidad
* Aumentar la calidad del aire
* Reducir el ruido ambiental

Los aytos ya tenian medios para limitar la velocidad!!

## Reducir la mortalidad

En 2019, 1496 personas perdieron la vida por un acc. de trafico en Espana. Sin embargo, a pesar de lo tragico del dato, supone un descenso de la mortalidad por 2nd ano consecutivo (no se dispone de informacion en 2020). El numero de peatones fallecidos tambien disminuyo sensiblemente en 2019.

```{r}
tit_via = c("municipal" = 4)
input_files <- paste0("data_sources/TABLA_ACCIDENTES_", 16:19, ".csv")
input_files <- set_names(input_files, 2016:2019)
raw_data <- map_dfr(input_files, read_csv, .id = "year")

raw_data_1 <- 
  raw_data %>% 
  select(year, COD_PROVINCIA, COD_MUNICIPIO, TITULARIDAD_VIA, TIPO_VIA, TOTAL_MU30DF,
         TOT_PEAT_MU30DF, TOTAL_MU24H, TOT_PEAT_MU24H)

fallecidos <- 
  raw_data_1 %>%
  group_by(year) %>% 
  summarize(across(ends_with(c("MU24H", "MU30DF")), sum))

fallecidos %>% 
  rename(TOTAL_FALLECIDOS = TOTAL_MU24H, PEATONES_FALLECIDOS = TOT_PEAT_MU24H) %>% 
  pivot_longer(cols = c("TOTAL_FALLECIDOS", "PEATONES_FALLECIDOS")) %>%
  ggplot() +
  geom_line(aes(x = year, y = value, group = name)) +
  geom_point(aes(x = year, y = value)) +
  facet_wrap(facets = vars(name), scales = "free_y", strip.position = "top") +
  xlab(NULL) + ylab(NULL) +
  labs(
    title = "Serie historica de fallecimientos por accidente de tráfico"
    , subtitle = "Datos de la DGT (cómputo 24 horas)"
    , caption = "\nYouTube: Darckula - en busca de la verdad\nTwitter: @darckula" 
  )
```

En cambio, el numero de peatones que perdieron la vida por un atropello en ciudad ascendio en 2019 en 10 personas, llegando hasta los 162. Este incremento es el 6% que la DGT esgrime como justifacion para la reduccion de los limites de velocidad.

```{r}

fallecidos_ciudad <- 
  raw_data_1 %>%
  filter(TITULARIDAD_VIA == tit_via["municipal"]) %>% 
  group_by(year, TITULARIDAD_VIA) %>% 
  summarize(across(ends_with(c("MU24H", "MU30DF")), sum))


fallecidos_ciudad %>% 
  rename(TOTAL_FALLECIDOS = TOTAL_MU24H, PEATONES_FALLECIDOS = TOT_PEAT_MU24H) %>% 
  pivot_longer(cols = c("TOTAL_FALLECIDOS", "PEATONES_FALLECIDOS")) %>%
  ggplot() +
  geom_line(aes(x = year, y = value, group = name)) +
  geom_point(aes(x = year, y = value)) +
  facet_wrap(facets = vars(name), scales = "free_y", strip.position = "top") +
  xlab(NULL) + ylab(NULL) +
  labs(
    title = "Serie historica de fallecimientos EN CIUDAD por accidente de tráfico"
    , subtitle = "Datos de la DGT (cómputo 24 horas)"
    , caption = "\nYouTube: Darckula - en busca de la verdad\nTwitter: @darckula" 
  )
```


En cuanto a la distribucion por lugar donde se produjeron los atropellos mortales (ciudad o fuera de ciudad), el siguiente grafico muestra un reparto casi al 50%, con una ligera tendencia hacia la ciudad. Las medidas que ha impuesto el gobierno se centrarian en reducir la mortalidad dentro de la ciudades, pero dejaria sin abordar casi el otro 50% del problema.


```{r}

raw_data_1 %>%
  group_by(year, CIUDAD = case_when(
      TITULARIDAD_VIA == tit_via["municipal"] ~ "Ciudad"
    , TRUE ~ "Fuera Ciudad")) %>%
  summarize(across(ends_with(c("MU30DF", "MU24H")), sum)) %>% 
  group_by(year) %>% 
  mutate(pct = round(100 * TOT_PEAT_MU24H / sum(TOT_PEAT_MU24H))) %>%  
  ggplot(aes(x = year, y = TOT_PEAT_MU24H, fill = CIUDAD)) +
  geom_col() +
  geom_text(aes(label = paste0(pct, "%")), position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette = 3, type = "seq", direction = 1) +
    xlab(NULL) + ylab(NULL) +
  labs(
    title = "Distribución historica de fallecimientos por accidente de tráfico"
    , subtitle = "Datos de la DGT (cómputo 24 horas)"
    , caption = "\nYouTube: Darckula - en busca de la verdad\nTwitter: @darckula" 
  )
  

```

Problemas

Centrandonos en los atropellos en vias urbanas, el argumento que maneja la DGT para justificar la reduccion de la velocidad son:

* Disminucion distancia de frenado:
  * 30 km/h se necesitan 15 metros
  * 50 km/h se necesitan 30 metros
* Disminucion de probabilidad de lession grave o mortal:
  * 50 km/h - 50%
  * 30 km/h - 10%
* Pero esto es pura teoria:
  * tiempo de reacción
  * el tipo de vehículo y estado de conservación

Ademas, pone el foco en evitar lesiones una vez producido el atropello en vez de tratar de evitarlo, para lo cual debemos estudiar la causa de la colision:
* baja visibilidad
* no respetar pazo de cebra o semaforo
* invadir la calzada de forma inadvertida
* en general, se ha infringido alguna norma?


```{r}
fallecimientos_peaton <- tribble(
  ~año, ~zona, ~infraccion, ~no_infraccion, ~desconocido,
  2019, "vias interurbanas", 92, 18, 24,
  2019, "travesia", 8, 4, 7,
  2019, "vias urbanas", 75, 92, 61
)

fallecimientos_peaton <- 
  fallecimientos_peaton %>% 
    pivot_longer(
        cols = c(infraccion, no_infraccion, desconocido)
      , names_to = "tipo"
      , values_to = "fallecidos")

text_to_show <- 
  fallecimientos_peaton %>%
    filter(tipo != "desconocido") %>%
    group_by(tipo) %>%
    summarize(fallecidos = sum(fallecidos)) %>% 
    mutate(pct = round(100 * fallecidos/sum(fallecidos)))

fallecimientos_peaton %>%
  filter(tipo != "desconocido") %>% 
  ggplot() +
  geom_col(aes(tipo, fallecidos, fill = zona), position = "stack") +
  scale_fill_brewer(palette = 3, type = "seq", direction = 1) +
  xlab(NULL) +
  ylab(NULL) +
  labs(
    title = "Atropellos mortales a peatones",
    subtitle = "Datos de la DGT 2019 (cómputo de 30 días)",
    caption = "\nYouTube: Darckula - en busca de la verdad\nTwitter: @darckula" ) +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  geom_text(  data = text_to_show 
            , aes(x = tipo, y = fallecidos, label = paste0(fallecidos, " (", pct, "%)"))
            , position = position_dodge(width = 1)
            , vjust = "bottom"
            , colour = "black"
            , family = "Ubuntu"
            , size = 5)

```

No se puede eludir la responsablidad de peatón en este asunto, puesto que tiene un papel fundamental.

Otro problema mas es que la siniestralidad no es igual en todas la ciudades y en todas las calles de España.

```{r}
master_provincias <- read_csv(file = "data_sources/master_provincias.csv")

raw_data_1 %>% 
  group_by(COD_PROVINCIA) %>% 
  summarize(across(ends_with(c("MU30DF", "MU24H")), sum)) %>% 
  left_join(master_provincias) %>% 
  ggplot(aes(reorder(PROVINCIA, TOT_PEAT_MU24H), TOT_PEAT_MU24H)) +
  geom_col(fill = "#FF00FF") +
  coord_flip() +
  xlab(NULL) + ylab(NULL) +
  labs(
    title = "Atropellos mortales por provincia",
    subtitle = "Datos de la DGT 2019 (cómputo de 24 horas)",
    caption = "\nYouTube: Darckula - en busca de la verdad\nTwitter: @darckula" )

```



## Factores mediamabientales

* Contaminación:
  * Mas atascos
  * no esta claro que se contamine menos a 30 que ha 50%
  * vehiculos electricos
  

* Ruido
  * revoluciones del motor
  

# Oportunidades recaudatorias


  




